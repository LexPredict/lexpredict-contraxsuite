{% extends "base.html" %}
{% load static pipeline %}

{% block css_extra %}
  {% stylesheet 'custom_jqwidgets_css' %}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.1.1/jquery-confirm.min.css">
  <style>
    #tabs1>ul {
      border-bottom: none;
    }
    #tabs1>ul>li {
      border-bottom: 1px solid #DDD;
      margin-bottom: 10px;
    }
    #tab1-other+ul li {
      padding: 0.25rem .5rem;
    }
    #tab1-other+ul li a {
      padding: .25rem;
      line-height: 30px;
    }
  </style>
  {{ block.super }}
{% endblock %}

{% block page_header %}Document Detail{% endblock %}

{% block project_selection %}{% endblock %}

{% block content %}
  <div>
    <a class="btn-u btn-sm" id="button_view_raw_document"
       href="{% url "document:show-document" document.id %}" target="_blank">
{#       href="{% url "document:document-source" document.id %}" target="_blank">#}
      View Source Document
    </a>
    <a class="btn-u btn-sm"
       href="{% url "document:document-enhanced-view" document.id %}">
      View Enhanced Document
    </a>
  </div>
  <table class="table table-bordered table-striped">
    <thead class="thead-inverse">
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Relations</th>
    </tr>
    </thead>
    <tbody>
    <tr>
      <td>{{ document.name }}</td>
      <td>{{ document.document_type.title }}</td>
      <td>{{ document.description }}</td>
      <td>{{ document.document_a_set.count|add:document.document_b_set.count }}</td>
    </tr>
    </tbody>
  </table>

  <div class="toggle">
    <div class="togglet"><i class="toggle-closed icon-ok-circle"></i><i class="toggle-open icon-remove-circle"></i>Source Document Metadata</div>
    <div class="togglec">
      <table class="table table-bordered table-striped">
        <thead class="thead-inverse">
        <tr>
          <th>Key</th>
          <th>Value</th>
        </tr>
        </thead>
        <tbody>
        {% if document.metadata %}
          {% for key, value in document.metadata.items %}
            <tr>
              <td>{{ key }}</td>
              <td>{{ value }}</td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="2">No data</td>
          </tr>
        {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="page-tabs mb-40" id="tabs1">

      <ul class="nav nav-tabs boot-tabs">
      <li><a data-toggle="tab" href="#tab-1" class="active">Text Units<span class="badge badge-s text-units-badge"></span></a></li>
      <li><a data-toggle="tab" href="#tab-2">Parties<span class="badge badge-s parties-badge"></span></a></li>
      <li><a data-toggle="tab" href="#tab-3">Terms<span class="badge badge-s terms-badge"></span></a></li>
      <li><a data-toggle="tab" href="#tab-4">Entities<span class="badge badge-s entities-badge"></span></a></li>
      <li><a data-toggle="tab" href="#tab-5">Notes<span class="badge badge-s notes-badge"></span></a></li>
      <li><a data-toggle="tab" href="#tab-6">Tags<span class="badge badge-s tags-badge"></span></a></li>
      <li><a data-toggle="tab" href="#tab-7">Properties<span class="badge badge-s properties-badge"></span></a></li>
      <li class="dropdown">
        <a href="#" id="tab1-other" class="dropdown-toggle" data-toggle="dropdown">
          <span>Other Items</span>
          <b class="caret"></b>
        </a>
        <ul class="dropdown-menu" role="menu" aria-labelledby="tab1-dropdown" style="width: 240px;">
          {% if 'amount' in available_locators %}
            <li class="dropdown-item"><a data-toggle="tab" class="other" href="#tab-8">Amounts<span class="badge badge-s amounts-badge"></span></a></li>
          {% endif %}
          {% if 'citation' in available_locators %}
            <li class="dropdown-item"><a data-toggle="tab" class="other" href="#tab-9">Citations<span class="badge badge-s citations-badge"></span></a></li>
          {% endif %}
          {% if 'copyright' in available_locators %}
            <li class="dropdown-item"><a data-toggle="tab" class="other" href="#tab-10">Copyrights<span class="badge badge-s copyrights-badge"></span></a></li>
          {% endif %}
          {% if 'court' in available_locators %}
            <li class="dropdown-item"><a data-toggle="tab" class="other" href="#tab-11">Courts<span class="badge badge-s courts-badge"></span></a></li>
          {% endif %}
          {% if 'currency' in available_locators %}
            <li class="dropdown-item"><a data-toggle="tab" class="other" href="#tab-12">Currencies<span class="badge badge-s currencies-badge"></span></a></li>
          {% endif %}
          <li><a data-toggle="tab" class="other" href="#tab-13">Dates<span class="badge badge-s dates-badge"></span></a></li>
          {% if 'duration' in available_locators %}
            <li class="dropdown-item"><a data-toggle="tab" class="other" href="#tab-14">Date Durations<span class="badge badge-s durations-badge"></span></a></li>
          {% endif %}
          {% if 'definition' in available_locators %}
            <li class="dropdown-item"><a data-toggle="tab" class="other" href="#tab-15">Definitions<span class="badge badge-s definitions-badge"></span></a></li>
          {% endif %}
          {% if 'distance' in available_locators %}
            <li class="dropdown-item"><a data-toggle="tab" class="other" href="#tab-16">Distances<span class="badge badge-s distances-badge"></span></a></li>
          {% endif %}
          {% if 'percent' in available_locators %}
            <li class="dropdown-item"><a data-toggle="tab" class="other" href="#tab-17">Percents<span class="badge badge-s percents-badge"></span></a></li>
          {% endif %}
          {% if 'ratio' in available_locators %}
            <li class="dropdown-item"><a data-toggle="tab" class="other" href="#tab-18">Ratios<span class="badge badge-s ratios-badge"></span></a></li>
          {% endif %}
          {% if 'regulation' in available_locators %}
            <li class="dropdown-item"><a data-toggle="tab" class="other" href="#tab-19">Regulations<span class="badge badge-s regulations-badge"></span></a></li>
          {% endif %}
          {% if 'trademark' in available_locators %}
            <li class="dropdown-item"><a data-toggle="tab" class="other" href="#tab-20">Trademarks<span class="badge badge-s trademarks-badge"></span></a></li>
          {% endif %}
          {% if 'url' in available_locators %}
            <li class="dropdown-item"><a data-toggle="tab" class="other" href="#tab-21">Urls<span class="badge badge-s urls-badge"></span></a></li>
          {% endif %}
        </ul>
      </li>

    </ul>

    <div  class="tab-content">

      <div class="tab-pane clearfix active" id="tab-1">
        <div class="pull-right header-search-form highlight-container">
          <div class="input-group">
<!--            <span class="input-group-btn">-->
<!--              <button class="btn btn-warning" type="button">Highlight</button>-->
<!--            </span>-->
            <input type="text" class="form-control" id="highlight_term" name="highlight_term"
                   placeholder="Highlight terms" value="{{ highlight|default:"" }}" >
          </div>
        </div>
        <div class="pull-right grid-controls">
          {% include '_base_grid_buttons_block.html' %}
        </div>
        <div class="jqxgrid-container">
          <div class="jqxgrid col-md-12 jqxgrid-text-units"></div>
        </div>
      </div>

      <div class="tab-pane clearfix" id="tab-2">
        <div class="pull-right grid-controls">
          {% include '_base_grid_buttons_block.html' %}
        </div>
        <div class="jqxgrid-container">
          <div class="jqxgrid col-md-12 jqxgrid-top-party-usages"></div>
        </div>
      </div>

      <div class="tab-pane clearfix" id="tab-3">
        <div class="pull-right grid-controls">
          {% include '_base_grid_buttons_block.html' %}
        </div>
        <div class="jqxgrid-container">
          <div class="jqxgrid col-md-12 jqxgrid-top-term-usages"></div>
        </div>
      </div>

      <div class="tab-pane clearfix" id="tab-4">
        <div class="pull-right grid-controls">
          {% include '_base_grid_buttons_block.html' %}
        </div>
        <div class="jqxgrid-container">
          <div class="jqxgrid col-md-12 jqxgrid-top-entity-usages"></div>
        </div>
      </div>

      <div class="tab-pane clearfix" id="tab-5">
        <div class="pull-right grid-controls">
          {% include '_base_grid_buttons_block.html' %}
          <button type="button" class="btn-u btn-sm btn-s pull-right"
                  onclick="show_note_popup('.jqxgrid-notes', null, 'document', {{ document.pk }} )">Create</button>
        </div>
        <div class="jqxgrid-container">
          <div class="jqxgrid col-md-12 jqxgrid-notes"></div>
        </div>
      </div>

      <div class="tab-pane clearfix" id="tab-6">
        <div class="pull-right grid-controls">
          {% include '_base_grid_buttons_block.html' %}
          <button type="button" class="btn-u btn-sm btn-s pull-right"
                  onclick="tag_popup('document', {{ document.pk }}, '.jqxgrid-tags')">Create</button>
        </div>
        <div class="jqxgrid-container">
          <div class="jqxgrid col-md-12 jqxgrid-tags"></div>
        </div>
      </div>

      <div class="tab-pane clearfix" id="tab-7">
        <div class="pull-right grid-controls">
          {% include '_base_grid_buttons_block.html' %}
          <button type="button" class="btn-u btn-sm btn-s pull-right"
                  onclick="document_property_popup('document', {{ document.pk }}, '.jqxgrid-properties')">Create</button>
        </div>
        <div class="jqxgrid-container">
          <div class="jqxgrid col-md-12 jqxgrid-properties"></div>
        </div>
      </div>

      {% if 'amount' in available_locators %}
        <div class="tab-pane clearfix" id="tab-8">
          <div class="pull-right grid-controls">
            {% include '_base_grid_buttons_block.html' %}
          </div>
          <div class="jqxgrid-container">
            <div class="jqxgrid col-md-12 jqxgrid-amounts"></div>
          </div>
        </div>
      {% endif %}

      {% if 'citation' in available_locators %}
        <div class="tab-pane clearfix" id="tab-9">
          <div class="pull-right grid-controls">
            {% include '_base_grid_buttons_block.html' %}
          </div>
          <div class="jqxgrid-container">
            <div class="jqxgrid col-md-12 jqxgrid-citations"></div>
          </div>
        </div>
      {% endif %}

      {% if 'copyright' in available_locators %}
        <div class="tab-pane clearfix" id="tab-10">
          <div class="pull-right grid-controls">
            {% include '_base_grid_buttons_block.html' %}
          </div>
          <div class="jqxgrid-container">
            <div class="jqxgrid col-md-12 jqxgrid-copyrights"></div>
          </div>
        </div>
      {% endif %}

      {% if 'court' in available_locators %}
        <div class="tab-pane clearfix" id="tab-11">
          <div class="pull-right grid-controls">
            {% include '_base_grid_buttons_block.html' %}
          </div>
          <div class="jqxgrid-container">
            <div class="jqxgrid col-md-12 jqxgrid-courts"></div>
          </div>
        </div>
      {% endif %}

      {% if 'currency' in available_locators %}
        <div class="tab-pane clearfix" id="tab-12">
          <div class="pull-right grid-controls">
            {% include '_base_grid_buttons_block.html' %}
          </div>
          <div class="jqxgrid-container">
            <div class="jqxgrid col-md-12 jqxgrid-currencies"></div>
          </div>
        </div>
      {% endif %}

      <div class="tab-pane clearfix" id="tab-13">
        <div class="pull-right grid-controls">
          <a class="btn-u btn-sm"
             href="{% url "extract:date-usage-export-ical" %}?document_pk={{ document.id }}">
            Export Dates
          </a>
          {% include '_base_grid_buttons_block.html' %}
        </div>
        <div class="jqxgrid-container">
          <div class="jqxgrid col-md-12 jqxgrid-dates"></div>
        </div>
      </div>

      {% if 'duration' in available_locators %}
        <div class="tab-pane clearfix" id="tab-14">
          <div class="pull-right grid-controls">
            {% include '_base_grid_buttons_block.html' %}
          </div>
          <div class="jqxgrid-container">
            <div class="jqxgrid col-md-12 jqxgrid-durations"></div>
          </div>
        </div>
      {% endif %}

      {% if 'definition' in available_locators %}
        <div class="tab-pane clearfix" id="tab-15">
          <div class="pull-right grid-controls">
            {% include '_base_grid_buttons_block.html' %}
          </div>
          <div class="jqxgrid-container">
            <div class="jqxgrid col-md-12 jqxgrid-definitions"></div>
          </div>
        </div>
      {% endif %}

      {% if 'distance' in available_locators %}
        <div class="tab-pane clearfix" id="tab-16">
          <div class="pull-right grid-controls">
            {% include '_base_grid_buttons_block.html' %}
          </div>
          <div class="jqxgrid-container">
            <div class="jqxgrid col-md-12 jqxgrid-distances"></div>
          </div>
        </div>
      {% endif %}

      {% if 'percent' in available_locators %}
        <div class="tab-pane clearfix" id="tab-17">
          <div class="pull-right grid-controls">
            {% include '_base_grid_buttons_block.html' %}
          </div>
          <div class="jqxgrid-container">
            <div class="jqxgrid col-md-12 jqxgrid-percents"></div>
          </div>
        </div>
      {% endif %}

      {% if 'ratio' in available_locators %}
        <div class="tab-pane clearfix" id="tab-18">
          <div class="pull-right grid-controls">
            {% include '_base_grid_buttons_block.html' %}
          </div>
          <div class="jqxgrid-container">
            <div class="jqxgrid col-md-12 jqxgrid-ratios"></div>
          </div>
        </div>
      {% endif %}

      {% if 'regulation' in available_locators %}
        <div class="tab-pane clearfix" id="tab-19">
          <div class="pull-right grid-controls">
            {% include '_base_grid_buttons_block.html' %}
          </div>
          <div class="jqxgrid-container">
            <div class="jqxgrid col-md-12 jqxgrid-regulations"></div>
          </div>
        </div>
      {% endif %}

      {% if 'trademark' in available_locators %}
        <div class="tab-pane clearfix" id="tab-20">
          <div class="pull-right grid-controls">
            {% include '_base_grid_buttons_block.html' %}
          </div>
          <div class="jqxgrid-container">
            <div class="jqxgrid col-md-12 jqxgrid-trademarks"></div>
          </div>
        </div>
      {% endif %}

      {% if 'url' in available_locators %}
        <div class="tab-pane clearfix" id="tab-21">
          <div class="pull-right grid-controls">
            {% include '_base_grid_buttons_block.html' %}
          </div>
          <div class="jqxgrid-container">
            <div class="jqxgrid col-md-12 jqxgrid-urls"></div>
          </div>
        </div>
      {% endif %}

    </div>
  </div>

  <div class="page-tabs" id="tabs2">

    <ul class="nav nav-tabs boot-tabs">
      <li><a data-toggle="tab" href="#tab-31" class="active">Task Queues<span class="badge badge-s task-queues-badge"></span></a></li>
      <li><a data-toggle="tab" href="#tab-32">Clusters<span class="badge badge-s clusters-badge"></span></a></li>
      <li><a data-toggle="tab" href="#tab-33">Document Similarity<span class="badge badge-s similarity-badge"></span></a></li>
      <li><a data-toggle="tab" href="#tab-34">Extracted Tables<span class="badge badge-s tables-badge">{{ document.metadata.tables|length }}</span></a></li>
      <li><a data-toggle="tab" href="#tab-35">Document Log<span class="badge badge-s tables-badge"></span></a></li>
    </ul>

    <div class="tab-content">
      <div class="tab-pane clearfix active" id="tab-31">
        <div class="pull-right grid-controls">
          {% include '_base_grid_buttons_block.html' %}
          <div class="btn-group text-center pull-right" style="margin-top: 5px;">
            <button type="button" class="btn-u btn-sm dropdown-toggle"
                    data-toggle="dropdown" aria-haspopup="true">
              Add To Task Queue
              <span class="caret"></span>
            </button>
            <ul class="dropdown-menu dropdown-menu-right">
              {% for task_queue in extra_task_queue_list %}
                <li class="dropdown-item">
                  <a href="{% url "project:add-to-task-queue" task_queue.pk document.pk %}#tab-2-2"
                     class="add_to_task_queue">
                    {{ task_queue }} / {{ task_queue.description }}</a>
                </li>
              {% endfor %}
            </ul>
          </div>
        </div>
        <div class="jqxgrid-container">
          <div class="jqxgrid col-md-12 jqxgrid-task-queues"></div>
        </div>
      </div>

      <div class="tab-pane clearfix" id="tab-32">
        <div class="pull-right grid-controls">
          {% include '_base_grid_buttons_block.html' %}
        </div>
        <div class="jqxgrid-container">
          <div class="jqxgrid col-md-12 jqxgrid-clusters"></div>
        </div>
      </div>

      <div class="tab-pane clearfix" id="tab-33">
        <div class="pull-right grid-controls">
          {% include '_base_grid_buttons_block.html' %}
        </div>
        <div class="jqxgrid-container">
          <div class="jqxgrid col-md-12 jqxgrid-similarity"></div>
        </div>
      </div>

      <div class="tab-pane clearfix" id="tab-34">
        {% include 'document/_document_tables.html' %}
      </div>

      <div class="tab-pane clearfix" id="tab-35">
        {% include 'document/_document_tasks.html' %}
      </div>

   </div>
  </div>

{% endblock %}

{% block js_extra %}
  {% include "_base_jqxgrid_block.html" %}

  <script type="text/javascript">
    // TODO: Highlight in paginated view??
    highlightTerms(".jqxgrid-text-units", 2);
    highlightParties(".jqxgrid-text-units", {{ party_list|safe }});
  </script>

  {% include "document/_document_property_popup_js.html" %}

  <script type="text/javascript">
    var draw_patched_grid = function (selector, datafields, columns, server_pagination,
                           custom_source_data, custom_grid_options) {
        columns.records = [];
        draw_grid(selector, datafields, columns, server_pagination,
                  custom_source_data, custom_grid_options);
        window.renderedGrid = $(selector);
        // var row = grid.jqxGrid('getrowdata', row_number);
    }

    $(document).ready(function () {

      // common text units nested table initialization
      var text_units_nested_grid_data = function(nested_data_item_name, url, data){
        var nested_grid_initrowdetails = function(index, parentElement, gridElement, record) {
          var grid = $($(parentElement).children()[0]);
          grid.attr('id', 'grid' + record.boundindex);
          var details_source = {
            datafields: [
              { name: 'count', type: 'int' },
              { name: 'text_unit__textunittext__text', type: 'string' },
              { name: 'detail_url', type: 'string' }
            ],
            localdata: record[nested_data_item_name]
          };
          var nestedGridAdapter = new $.jqx.dataAdapter(details_source);
          if (grid != null) {
            var menu_renderer = function(row) {
              row = grid.jqxGrid('getrowdata', row);
              var menu_data = [
                { url: row.detail_url,
                  icon: 'fa fa-info-circle',
                  text: 'View Text Unit' }
              ];
              show_menu(menu_data, grid, row.pk);
            };
            grid.jqxGrid({
              source: nestedGridAdapter,
              altrows: true,
              rowsheight: 40,
              enabletooltips: true,
              sortable: true,
              filterable: true,
              width: '98%',
              height: 200,
              columns: [
                { text: 'Count', datafield: 'count', width: 60,
                  align: 'center', cellsalign: 'center' },
                { text: 'Text Unit', datafield: 'text_unit__textunittext__text', sortable: false, width: 'auto',
                  align: 'center', cellsalign: 'center' },
                { text: 'Action', datafield: 'url', width: 60,
                  align: 'center', exportable: false,
                  columntype: 'button',
                  sortable: false, filterable: false, menu: false,
                  cellsrenderer: function(){ return 'Menu' },
                  buttonclick: menu_renderer }
              ]
            });
          }
        };
        return {
          rowdetails: true,
          initrowdetails: nested_grid_initrowdetails,
          rowdetailstemplate: {
            rowdetails: "<div id='grid' class='sub-grid' style='margin: 10px;'></div>",
            rowdetailsheight: 220,
            rowdetailshidden: true
          }
        };
      };

      // Text Units table
      var text_units_datafields = [
        { name: 'pk', type: 'int' },
        { name: 'unit_type', type: 'string' },
        { name: 'language', type: 'string' },
        { name: 'textunittext__text', type: 'string' },
        { name: 'detail_url', type: 'string' }
      ];
      var text_units_menu_renderer = function(row) {
        var grid = $('.jqxgrid-text-units');
        row = grid.jqxGrid('getrowdata', row);
        var menu_data = [
          { url: row.detail_url,
            icon: 'fa fa-info-circle',
            text: 'View Text Unit'},
          { icon: 'fa fa-tags',
            cls: 'tag-text-unit',
            text: 'Tag'},
          { icon: 'fa fa-gavel',
            cls: 'classify-text-unit',
            text: 'Classify'}
        ];
        show_menu(menu_data, grid, row.pk);
      };
      var text_units_columns = [
        { text: 'Unit Type', datafield: 'unit_type', width: 80,
          align: 'center', cellsalign: 'center' },
        { text: 'Language', datafield: 'language', width: 80,
          align: 'center', cellsalign: 'center' },
        { text: 'Text', datafield: 'textunittext__text', width: 'auto',
          align: 'center', cellsalign: 'center' },
        { text: 'Action', datafield: 'edit_url', width: 60,
          align: 'center', exportable: false,
          columntype: 'button',
          sortable: false, filterable: false, menu: false,
          cellsrenderer: function(){return 'Menu'},
          buttonclick: text_units_menu_renderer }
      ];
      var text_units_custom_source_data = {
        url: '{% url "document:text-unit-list" %}',
        data: {'document_pk': {{ document.pk }} },
        badgeClass: 'text-units-badge'
      };
      draw_patched_grid(".jqxgrid-text-units", text_units_datafields, text_units_columns, true, text_units_custom_source_data);

      // Parties table
      var parties_datafields = [
        { name: 'party__name', type: 'string' },
        { name: 'party__type_abbr', type: 'string' },
        { name: 'count', type: 'int' },
        { name: 'party_summary_url', type: 'string' },
        { name: 'party_data' }
      ];
      var parties_menu_renderer = function(row_number) {
        var grid = $('.jqxgrid-top-party-usages');
        var row = grid.jqxGrid('getrowdata', row_number);
        var menu_data = [
          { icon: 'fa fa-folder-open-o',
            onclick: "expand_row(event, '.jqxgrid-top-party-usages', " + row_number + ")",
            text: 'Show Details' },
          { icon: 'fa fa-bars',
            onclick: "event.preventDefault(); apply_filter('.jqxgrid-text-units', 'text', '" + row.party__name + "', '#tabs1', 0)",
            text: 'View Related Text Units' },
          { icon: 'fa fa-search',
            url:  '{% url "extract:party-usage-list" %}?party_search=' + row.party__name,
            text: 'View Similar Party Usages' },
          { icon: 'fa fa-cubes',
            url:  row.party_summary_url,
            text: 'View Party Summary' }
        ];
        show_menu(menu_data, grid, row.pk, 300);
      };
      var partyNameFormatter = function (index, columnfield, value, defaulthtml, columnproperties, row) {
        return linkFormatter(defaulthtml, row.party_summary_url, value);
      };
      var parties_columns = [
        { text: 'Name', datafield: 'party__name', width: 'auto',
          align: 'center', cellsalign: 'center', columngroup: 'Party',
          cellsrenderer: partyNameFormatter },
        { text: 'Type', datafield: 'party__type_abbr', width: 'auto',
          align: 'center', cellsalign: 'center', columngroup: 'Party' },
        { text: 'Count', datafield: 'count', width: 150,
          align: 'center', cellsalign: 'center' },
        { text: 'Action', datafield: 'url', width: 60,
          align: 'center', exportable: false,
          columntype: 'button',
          sortable: false, filterable: false, menu: false,
          cellsrenderer: function(){return 'Menu'},
          buttonclick: parties_menu_renderer }
      ];
      var parties_custom_source_data = {
        url: '{% url "extract:top-party-usage-list" %}',
        data: { 'document_pk': {{ document.pk }} },
        badgeClass: 'parties-badge'
      };
      draw_patched_grid(".jqxgrid-top-party-usages", parties_datafields, parties_columns, false,
          parties_custom_source_data, text_units_nested_grid_data('party_data'));

      // Top Term Usages table
      var terms_datafields = [
        { name: 'term_id', type: 'int' },
        { name: 'term__term', type: 'string' },
        { name: 'count', type: 'int' },
        { name: 'term_data' }
      ];
      var terms_menu_renderer = function(row_number) {
        var grid = $('.jqxgrid-top-term-usages');
        var row = grid.jqxGrid('getrowdata', row_number);
        var menu_data = [
          { icon: 'fa fa-folder-open-o',
            onclick: "expand_row(event, '.jqxgrid-top-term-usages', " + row_number + ")",
            text: 'Show Details' },
          { icon: 'fa fa-search',
            url: '{% url "extract:term-usage-list" %}?term_search=' + row.term__term,
            text: 'View Similar Term Usages' }
        ];
        show_menu(menu_data, grid, row.pk, 300);
      };
      var terms_columns = [
        { text: 'Term', datafield: 'term__term', width: 'auto',
          align: 'center', cellsalign: 'center' },
        { text: 'Count', datafield: 'count', width: 'auto',
          align: 'center', cellsalign: 'center' },
        { text: 'Action', datafield: 'url', width: 60,
          align: 'center', exportable: false,
          columntype: 'button',
          sortable: false, filterable: false, menu: false,
          cellsrenderer: function(){return 'Menu'},
          buttonclick: terms_menu_renderer }
      ];
      var terms_custom_source_data = {
        url: '{% url "extract:top-document-term-usage-list" %}',
        data: { 'document_pk': {{ document.pk }} },
        badgeClass: 'terms-badge'
      };
      var terms_grid_initrowdetails = function(index, parentElement, gridElement, record) {
        var grid = $($(parentElement).children()[0]);
        grid.attr('id', 'grid' + record.boundindex);
        var datafields = [
          { name: 'count', type: 'int' },
          { name: 'text_unit__pk', type: 'int' },
          { name: 'count', type: 'int' },
          { name: 'text_unit__textunittext__text', type: 'string' },
          { name: 'detail_url', type: 'string' }
        ];
        var menu_renderer = function(row) {
          row = grid.jqxGrid('getrowdata', row);
          var menu_data = [
            { url: row.detail_url,
              icon: 'fa fa-info-circle',
              text: 'View Text Unit'}
          ];
          show_menu(menu_data, grid, row.pk);
        };
        var columns = [
          { text: 'Count', datafield: 'count', width: 60,
            align: 'center', cellsalign: 'center' },
          { text: 'Text Unit', datafield: 'text_unit__textunittext__text', sortable: false, width: 'auto', minwidth: 200,
            align: 'center', cellsalign: 'center' },
          { text: 'Action', datafield: 'url', width: 60,
            align: 'center', exportable: false,
            columntype: 'button',
            sortable: false, filterable: false, menu: false,
            cellsrenderer: function(){ return 'Menu' },
            buttonclick: menu_renderer }
        ];
        var custom_grid_options = {
          width: '98%',
          altrows: true,
          rowsheight: 40,
          enabletooltips: true,
          sortable: true,
          filterable: true,
          height: 200
        };
        var custom_source_data = {
          url: '{% url "extract:top-document-term-usage-list" %}',
          data: { 'document_pk': {{ document.pk }}, 'term_pk': record.term_id }
        };
        draw_patched_grid(grid, datafields, columns, false, custom_source_data, custom_grid_options);
      };
      var terms_custom_grid_opts = {
        rowdetails: true,
        initrowdetails: terms_grid_initrowdetails,
        rowdetailstemplate: {
          rowdetails: "<div id='grid' class='sub-grid' style='margin: 10px;'></div>",
          rowdetailsheight: 550,
          rowdetailshidden: true
        }
      };
      draw_patched_grid(".jqxgrid-top-term-usages", terms_datafields, terms_columns, false,
          terms_custom_source_data, terms_custom_grid_opts);

      // Top Geo Entity Usages table
      var entities_datafields = [
        { name: 'entity_id', type: 'int' },
        { name: 'entity__name', type: 'string' },
        { name: 'entity__category', type: 'string' },
        { name: 'entity_data' },
        { name: 'count', type: 'int' }
      ];
      var entities_menu_renderer = function(row_number) {
        var grid = $('.jqxgrid-top-entity-usages');
        var row = grid.jqxGrid('getrowdata', row_number);
        var menu_data = [
          { icon: 'fa fa-folder-open-o',
            onclick: "expand_row(event, '.jqxgrid-top-entity-usages', " + row_number + ")",
            text: 'Show Details' },
          { icon: 'fa fa-search',
            url:  '{% url "extract:geo-entity-usage-list" %}?entity_search=' + row.entity__name,
            text: 'View Similar Entity Usages' }
        ];
        show_menu(menu_data, grid, row.pk, 300);
      };
      var entities_columns = [
        { text: 'Entity Name', datafield: 'entity__name', width: 'auto',
          align: 'center', cellsalign: 'center' },
        { text: 'Entity Category', datafield: 'entity__category', width: 'auto',
          align: 'center', cellsalign: 'center' },
        { text: 'Count', datafield: 'count', width: 150,
          align: 'center', cellsalign: 'center' },
        { text: 'Action', datafield: 'url', width: 60,
          align: 'center', exportable: false,
          columntype: 'button',
          sortable: false, filterable: false, menu: false,
          cellsrenderer: function(){return 'Menu'},
          buttonclick: entities_menu_renderer }
      ];
      var entities_custom_source_data = {
        url: '{% url "extract:top-geo-entity-usage-list" %}',
        data: { 'document_pk': {{ document.pk }} },
        badgeClass: 'entities-badge'
      };
      var nested_grid_initrowdetails = function(index, parentElement, gridElement, record) {
        var grid = $($(parentElement).children()[0]);
        grid.attr('id', 'grid' + record.boundindex);
        var datafields = [
          { name: 'count', type: 'int' },
          { name: 'text_unit__textunittext__text', type: 'string' },
          { name: 'detail_url', type: 'string' }
        ];
        var menu_renderer = function(row) {
          row = grid.jqxGrid('getrowdata', row);
          var menu_data = [
            { url: row.detail_url,
              icon: 'fa fa-info-circle',
              text: 'View Text Unit'}
          ];
          show_menu(menu_data, grid, row.pk);
        };
        var columns = [
          { text: 'Count', datafield: 'count', width: 60,
            align: 'center', cellsalign: 'center' },
          { text: 'Text Unit', datafield: 'text_unit__textunittext__text', sortable: false, width: 'auto', minwidth: 200,
            align: 'center', cellsalign: 'center' },
          { text: 'Action', datafield: 'url', width: 60,
            align: 'center', exportable: false,
            columntype: 'button',
            sortable: false, filterable: false, menu: false,
            cellsrenderer: function(){ return 'Menu' },
            buttonclick: menu_renderer }
        ];
        var custom_grid_options = {
          width: '98%',
          altrows: true,
          rowsheight: 40,
          enabletooltips: true,
          sortable: true,
          filterable: true,
          height: 200
        };
        var custom_source_data = {
          url: '{% url "extract:geo-entity-usage-list" %}',
          data: { 'entity_pk': record.entity_id,
                  'document_pk': '{{ object.pk }}' }
        };
        draw_patched_grid(grid, datafields, columns, true, custom_source_data, custom_grid_options);
      };
      var entities_custom_grid_opts = {
        rowdetails: true,
        initrowdetails: nested_grid_initrowdetails,
        rowdetailstemplate: {
          rowdetails: "<div id='grid' class='sub-grid' style='margin: 10px;'></div>",
          rowdetailsheight: 550,
          rowdetailshidden: true
        }
      };
      draw_patched_grid(".jqxgrid-top-entity-usages", entities_datafields, entities_columns, true,
          entities_custom_source_data, entities_custom_grid_opts);

      // Notes table
      var notes_datafields = [
        { name: 'pk', type: 'int' },
        { name: 'document__pk', type: 'int' },
        { name: 'note', type: 'string' },
        { name: 'user', type: 'string' },
        { name: 'timestamp', type: 'date' },
        { name: 'history' },
        { name: 'delete_url', type: 'string' }
      ];
      var notes_menu_renderer = function(row_number) {
        var grid = $('.jqxgrid-notes');
        var row = grid.jqxGrid('getrowdata', row_number);
        var menu_data = [
          { icon: 'fa fa-pencil',
            onclick: "event.preventDefault();show_note_popup('.jqxgrid-notes', " + row_number + ", 'document', 'document__pk')",
            text: 'Edit Note' },
          { icon: 'fa fa-folder-open-o',
            onclick: "expand_row(event, '.jqxgrid-notes', " + row_number + ")",
            text: 'Show History' },
          { url: row.delete_url + '?next={{ request.path }}',
            icon: 'fa fa-remove',
            cls: 'remove',
            text: 'Remove' }
        ];
        show_menu(menu_data, grid, row.pk);
      };
      var notes_columns = [
        { text: 'User', datafield: 'user', width: 120,
          align: 'center', cellsalign: 'center' },
        { text: 'Date', datafield: 'timestamp', width: 120,
          filtertype: 'date', cellsformat: 'MM-dd-yyyy HH:mm',
          align: 'center', cellsalign: 'center' },
        { text: 'Note', datafield: 'note', width: 'auto',
          cellsrenderer: note_renderer,
          align: 'center', cellsalign: 'center' },
        { text: 'Action', datafield: 'url', width: 60,
          align: 'center', exportable: false,
          columntype: 'button',
          sortable: false, filterable: false, menu: false,
          cellsrenderer: function(){return 'Menu'},
          buttonclick: notes_menu_renderer }
      ];
      var notes_custom_source_data = {
        url: '{% url "document:document-note-list" %}',
        data: { 'document_pk': {{ document.pk }} },
        badgeClass: 'notes-badge'
      };
      // create nested grid
      var notes_initrowdetails = function(index, parentElement, gridElement, record) {
        var grid = $($(parentElement).children()[1]);
        var details_source = {
          datafields: [
            { name: 'document_id', type: 'int' },
            { name: 'history_date', type: 'date' },
            { name: 'history_user__username', type: 'string' },
            { name: 'note', type: 'string' }
          ],
          localdata: record.history
        };
        var nestedGridAdapter = new $.jqx.dataAdapter(details_source);
        if (grid != null) {
          grid.jqxGrid({
            source: nestedGridAdapter,
            altrows: true,
            rowsheight: 40,
            enabletooltips: true,
            sortable: true,
            filterable: true,
            width: '98%',
            height: 200,
            columns: [
              { text: 'Created Date', datafield: 'history_date', width: 150,
                filtertype: 'date', cellsformat: 'MM-dd-yyyy HH:mm',
                align: 'center', cellsalign: 'center' },
              { text: 'User', datafield: 'history_user__username', width: 150,
                align: 'center', cellsalign: 'center' },
              { text: 'Note', datafield: 'note', width: 'auto', minwidth: 300,
                cellsrenderer: note_renderer,
                align: 'center', cellsalign: 'center' }
            ]
          });
        }
      };
      var notes_custom_grid_options = {
        rowdetails: true,
        initrowdetails: notes_initrowdetails,
        rowdetailstemplate: {
          rowdetails: "<div class='sub-grid-title'>History</div><div id='grid' class='sub-grid'></div>",
          rowdetailsheight: 245,
          rowdetailshidden: true
        }
      };
      draw_patched_grid(".jqxgrid-notes", notes_datafields, notes_columns, false, notes_custom_source_data, notes_custom_grid_options);

      // Tags table
      var tags_datafields = [
        { name: 'pk', type: 'int' },
        { name: 'text_unit__pk', type: 'int' },
        { name: 'tag', type: 'string' },
        { name: 'user__username', type: 'string' },
        { name: 'timestamp', type: 'date' },
        { name: 'delete_url', type: 'string' }
      ];
      var tags_menu_renderer = function(row_number) {
        var grid = $('.jqxgrid-tags');
        var row = grid.jqxGrid('getrowdata', row_number);
        var menu_data = [
          { icon: 'fa fa-pencil',
            onclick: "tag_popup('document', {{ document.pk }}, '.jqxgrid-tags'," + row.pk + ", '" + row.tag + "')",
            text: 'Edit Tag' },
          { url: row.delete_url + '?next={{ request.path }}',
            icon: 'fa fa-remove',
            cls: 'remove',
            text: 'Remove'}
        ];
        show_menu(menu_data, grid, row.pk);
      };
      var tags_columns = [
        { text: 'User', datafield: 'user__username', width: 120,
          align: 'center', cellsalign: 'center' },
        { text: 'Date', datafield: 'timestamp', width: 120,
          filtertype: 'date', cellsformat: 'MM-dd-yyyy HH:mm',
          align: 'center', cellsalign: 'center' },
        { text: 'Tag', datafield: 'tag', width: 'auto',
          align: 'center', cellsalign: 'center' },
        { text: 'Action', datafield: 'url', width: 60,
          align: 'center', exportable: false,
          columntype: 'button',
          sortable: false, filterable: false, menu: false,
          cellsrenderer: function(){return 'Menu'},
          buttonclick: tags_menu_renderer }
      ];
      var tags_custom_source_data = {
        url: '{% url "document:document-tag-list" %}',
        data: { 'document_id': {{ document.pk }} },
        badgeClass: 'tags-badge'
      };
      draw_patched_grid(".jqxgrid-tags", tags_datafields, tags_columns, false, tags_custom_source_data);

      // Properties table
      var properties_datafields = [
        { name: 'pk', type: 'int' },
        { name: 'key', type: 'string' },
        { name: 'value', type: 'string' },
        { name: 'created_date', type: 'date' },
        { name: 'created_by__username', type: 'string' },
        { name: 'modified_date', type: 'date' },
        { name: 'modified_by__username', type: 'string' },
        { name: 'edit_url', type: 'string' },
        { name: 'delete_url', type: 'string' }
      ];
      var properties_menu_renderer = function(row) {
        var grid = $('.jqxgrid-properties');
        row = grid.jqxGrid('getrowdata', row);
        var menu_data = [
          { icon: 'fa fa-pencil',
            onclick: "event.preventDefault();document_property_popup('document', {{ document.pk }},'.jqxgrid-properties',"+row.pk+",'"+row.key+"','"+row.value+"')",
            text: 'Edit Property' },
          { url: row.delete_url + '?next={{ request.path }}',
            icon: 'fa fa-remove',
            cls: 'remove',
            text: 'Remove' }
        ];
        show_menu(menu_data, grid, row.pk);
      };
      var properties_columns = [
        { text: 'Property Name', datafield: 'key', width: 'auto',
          align: 'center', cellsalign: 'center' },
        { text: 'Property Value', datafield: 'value', width: 'auto',
          align: 'center', cellsalign: 'center' },
        { text: 'Created By', datafield: 'created_by__username', width: 120,
          align: 'center', cellsalign: 'center' },
        { text: 'Created Date', datafield: 'created_date', width: 120,
          filtertype: 'date', cellsformat: 'MM-dd-yyyy HH:mm',
          align: 'center', cellsalign: 'center' },
        { text: 'Modified By', datafield: 'modified_by__username', width: 120,
          align: 'center', cellsalign: 'center' },
        { text: 'Modified Date', datafield: 'modified_date', width: 120,
          filtertype: 'date', cellsformat: 'MM-dd-yyyy HH:mm',
          align: 'center', cellsalign: 'center' },
        { text: 'Action', datafield: 'edit_url', width: 60,
          align: 'center', exportable: false,
          columntype: 'button',
          sortable: false, filterable: false, menu: false,
          cellsrenderer: function(){return 'Menu'},
          buttonclick: properties_menu_renderer }
      ];
      var properties_custom_source_data = {
        url: '{% url "document:document-property-list" %}',
        data: { 'document_pk': {{ document.pk }} },
        badgeClass: 'properties-badge'
      };
      draw_patched_grid(".jqxgrid-properties", properties_datafields, properties_columns, false, properties_custom_source_data);

      // Top Date Usages table
      var dates_datafields = [
        { name: 'date', type: 'date' },
        { name: 'count', type: 'int' },
        { name: 'date_data' }
      ];
      var dates_menu_renderer = function(row_number) {
        var grid = $('.jqxgrid-dates');
        var row = grid.jqxGrid('getrowdata', row_number);
        var date_str = row.date.getFullYear()+'-'+(row.date.getMonth()+1)+'-'+row.date.getDate();
        var menu_data = [
          { icon: 'fa fa-folder-open-o',
            onclick: "expand_row(event, '.jqxgrid-dates', " + row_number + ")",
            text: 'Show Details' },
          { icon: 'fa fa-search',
            url:  '{% url "extract:date-usage-list" %}?date_search=' + date_str,
            text: 'View Similar Date Usages' }
        ];
        show_menu(menu_data, grid, row.pk, 300);
      };
      var dates_columns = [
        { text: 'Date', datafield: 'date', width: 'auto',
          align: 'center', cellsalign: 'center',
          filtertype: 'date', format: 'yyyy-MM-dd', cellsformat: 'yyyy-MM-dd' },
        { text: 'Count', datafield: 'count', width: 150,
          align: 'center', cellsalign: 'center' },
        { text: 'Action', datafield: 'url', width: 60,
          align: 'center', exportable: false,
          columntype: 'button',
          sortable: false, filterable: false, menu: false,
          cellsrenderer: function(){return 'Menu'},
          buttonclick: dates_menu_renderer }
      ];
      var dates_custom_source_data = {
        url: '{% url "extract:top-date-usage-list" %}',
        data: { 'document_pk': {{ document.pk }} },
        badgeClass: 'dates-badge'
      };
      draw_patched_grid(".jqxgrid-dates", dates_datafields, dates_columns, false,
          dates_custom_source_data, text_units_nested_grid_data('date_data'));

      {% if 'definition' in available_locators %}
        // Top Definition Usages table
        var definitions_datafields = [
          { name: 'definition', type: 'string' },
          { name: 'count', type: 'int' },
          { name: 'definition_data' }
        ];
        var definitions_menu_renderer = function(row_number) {
          var grid = $('.jqxgrid-definitions');
          var row = grid.jqxGrid('getrowdata', row_number);
          var menu_data = [
            { icon: 'fa fa-folder-open-o',
              onclick: "expand_row(event, '.jqxgrid-definitions', " + row_number + ")",
              text: 'Show Details' },
            { icon: 'fa fa-search',
              url:  '{% url "extract:definition-usage-list" %}?definition_search=' + encodeURIComponent(row.definition),
              text: 'View Similar Definition Usages' }
          ];
          show_menu(menu_data, grid, row.pk, 300);
        };
        var definitions_columns = [
          { text: 'Definition', datafield: 'definition', width: 'auto',
            align: 'center', cellsalign: 'center' },
          { text: 'Count', datafield: 'count', width: 150,
            align: 'center', cellsalign: 'center' },
          { text: 'Action', datafield: 'url', width: 60,
            align: 'center', exportable: false,
            columntype: 'button',
            sortable: false, filterable: false, menu: false,
            cellsrenderer: function(){return 'Menu'},
            buttonclick: definitions_menu_renderer }
        ];
        var definitions_custom_source_data = {
          url: '{% url "extract:top-definition-usage-list" %}',
          data: { 'document_pk': {{ document.pk }} },
          badgeClass: 'definitions-badge'
        };
        draw_patched_grid(".jqxgrid-definitions", definitions_datafields, definitions_columns, false,
            definitions_custom_source_data, text_units_nested_grid_data('definition_data'));
      {% endif %}

      {% if 'duration' in available_locators %}
        // Top Date Duration Usages table
        var durations_datafields = [
          { name: 'amount', type: 'int' },
          { name: 'duration_type', type: 'string' },
          { name: 'duration_days', type: 'float' },
          { name: 'count', type: 'int' },
          { name: 'duration_data' }
        ];
        var durations_menu_renderer = function(row_number) {
          var grid = $('.jqxgrid-durations');
          var row = grid.jqxGrid('getrowdata', row_number);
          var menu_data = [
            { icon: 'fa fa-folder-open-o',
              onclick: "expand_row(event, '.jqxgrid-durations', " + row_number + ")",
              text: 'Show Details' },
            { icon: 'fa fa-search',
              url:  '{% url "extract:date-duration-usage-list" %}?duration_search=' + row.duration_str,
              text: 'View Similar Date Duration Usages' }
          ];
          show_menu(menu_data, grid, row.pk, 300);
        };
        var durations_columns = [
          { text: 'Amount', datafield: 'amount', width: 'auto',
            align: 'center', cellsalign: 'center' },
          { text: 'Duration Type', datafield: 'duration_type', width: 'auto',
            align: 'center', cellsalign: 'center' },
          { text: 'Days', datafield: 'duration_days', width: 'auto',
            align: 'center', cellsalign: 'center',
            cellsrenderer: defaultLinkFormatter  },
          { text: 'Count', datafield: 'count', width: 'auto',
            align: 'center', cellsalign: 'center' },
          { text: 'Action', datafield: 'url', width: 60,
            align: 'center', exportable: false,
            columntype: 'button',
            sortable: false, filterable: false, menu: false,
            cellsrenderer: function(){return 'Menu'},
            buttonclick: durations_menu_renderer }
        ];
        var durations_custom_source_data = {
          url: '{% url "extract:top-date-duration-usage-list" %}',
          data: { 'document_pk': {{ document.pk }} },
          badgeClass: 'durations-badge'
        };
        draw_patched_grid(".jqxgrid-durations", durations_datafields, durations_columns, false,
            durations_custom_source_data, text_units_nested_grid_data('duration_data'));
      {% endif %}

      {% if 'court' in available_locators %}
        // Top Court Usages table
        var courts_datafields = [
          { name: 'court__name', type: 'string' },
          { name: 'court__alias', type: 'string' },
          { name: 'count', type: 'int' },
          { name: 'court_data' }
        ];
        var courts_menu_renderer = function(row_number) {
          var grid = $('.jqxgrid-courts');
          var row = grid.jqxGrid('getrowdata', row_number);
          var menu_data = [
            { icon: 'fa fa-folder-open-o',
              onclick: "expand_row(event, '.jqxgrid-courts', " + row_number + ")",
              text: 'Show Details' },
            { icon: 'fa fa-search',
              url:  '{% url "extract:court-usage-list" %}?court=' + encodeURIComponent(row.court__name),
              text: 'View Similar Court Usages' }
          ];
          show_menu(menu_data, grid, row.pk, 300);
        };
        var courts_columns = [
          { text: 'Court Name', datafield: 'court__name', width: 'auto',
            align: 'center', cellsalign: 'center' },
          { text: 'Court Alias', datafield: 'court__alias', width: 150,
            align: 'center', cellsalign: 'center' },
          { text: 'Count', datafield: 'count', width: 150,
            align: 'center', cellsalign: 'center' },
          { text: 'Action', datafield: 'url', width: 60,
            align: 'center', exportable: false,
            columntype: 'button',
            sortable: false, filterable: false, menu: false,
            cellsrenderer: function(){return 'Menu'},
            buttonclick: courts_menu_renderer }
        ];
        var courts_custom_source_data = {
          url: '{% url "extract:top-court-usage-list" %}',
          data: { 'document_pk': {{ document.pk }} },
          badgeClass: 'courts-badge'
        };
        draw_patched_grid(".jqxgrid-courts", courts_datafields, courts_columns, false,
            courts_custom_source_data, text_units_nested_grid_data('court_data'));
      {% endif %}

      {% if 'currency' in available_locators %}
        // Top Currency Usages table
        var currencies_datafields = [
          { name: 'currency', type: 'string' },
          {#        { name: 'usage_type', type: 'string' },#}
          { name: 'count', type: 'int' },
          { name: 'url', type: 'string' },
          { name: 'currency_data' }
        ];
        var currencies_menu_renderer = function(row_number) {
          var grid = $('.jqxgrid-currencies');
          var row = grid.jqxGrid('getrowdata', row_number);
          var menu_data = [
            { icon: 'fa fa-folder-open-o',
              onclick: "expand_row(event, '.jqxgrid-currencies', " + row_number + ")",
              text: 'Show Details' },
            { icon: 'fa fa-search',
              url:  '{% url "extract:currency-usage-list" %}?currency_search=' + encodeURIComponent(row.currency),
              text: 'View Similar Currency Usages' }
          ];
          show_menu(menu_data, grid, row.pk, 300);
        };
        var currencies_columns = [
          { text: 'Currency', datafield: 'currency', width: 'auto',
            align: 'center', cellsalign: 'center',
            cellsrenderer: defaultLinkFormatter },
          {#        { text: 'Usage Type', datafield: 'usage_type', width: 'auto',#}
          {#          align: 'center', cellsalign: 'center' },#}
          { text: 'Count', datafield: 'count', width: 'auto',
            align: 'center', cellsalign: 'center' },
          { text: 'Action', datafield: 'url', width: 60,
            align: 'center', exportable: false,
            columntype: 'button',
            sortable: false, filterable: false, menu: false,
            cellsrenderer: function(){return 'Menu'},
            buttonclick: currencies_menu_renderer }
        ];
        var currencies_custom_source_data = {
          url: '{% url "extract:top-currency-usage-list" %}',
          data: { 'document_pk': {{ document.pk }} },
          badgeClass: 'currencies-badge'
        };
        // create nested grid.
        var currencies_initrowdetails = function(index, parentElement, gridElement, record) {
          var grid = $($(parentElement).children()[0]);
          grid.attr('id', 'grid' + record.boundindex);
          var details_source = {
            datafields: [
              { name: 'currency', type: 'string' },
              { name: 'amount', type: 'float' },
              { name: 'amount__str', type: 'string' },
              {#            { name: 'usage_type', type: 'string' },#}
              { name: 'text_unit__textunittext__text', type: 'string' },
              { name: 'detail_url', type: 'string' }
            ],
            localdata: record.currency_data
          };
          var nestedGridAdapter = new $.jqx.dataAdapter(details_source);
          if (grid != null) {
            var currencies_menu_renderer = function(row) {
              row = grid.jqxGrid('getrowdata', row);
              var menu_data = [
                { url: row.detail_url,
                  icon: 'fa fa-info-circle',
                  text: 'View Text Unit'}
              ];
              show_menu(menu_data, grid, row.pk, 300);
            };
            grid.jqxGrid({
              source: nestedGridAdapter,
              altrows: true,
              enabletooltips: true,
              sortable: true,
              filterable: true,
              width: '98%',
              height: 200,
              columns: [
                { text: 'Currency', datafield: 'currency', width: 80,
                  align: 'center', cellsalign: 'center', columngroup: 'Currency Info' },
                {#              { text: 'Type', datafield: 'usage_type', width: 100,#}
                {#                align: 'center', cellsalign: 'center', columngroup: 'Currency Info' },#}
                { text: 'Amount', datafield: 'amount', width: 120, cellsformat: 'f2',
                  align: 'center', cellsalign: 'center', columngroup: 'Currency Info' },
                { text: 'Text Unit', datafield: 'text_unit__textunittext__text', sortable: false, width: 'auto', minwidth: 300,
                  align: 'center', cellsalign: 'center' },
                { text: 'Action', datafield: 'edit_url', width: 60,
                  align: 'center', exportable: false,
                  columntype: 'button',
                  sortable: false, filterable: false, menu: false,
                  cellsrenderer: function(){return 'Menu'},
                  buttonclick: currencies_menu_renderer }
              ]
            });
          }
        };
        var currencies_custom_grid_options = {
          rowsheight: 60,
          pageable: false,
          rowdetails: true,
          initrowdetails: currencies_initrowdetails,
          rowdetailstemplate: {
            rowdetails: "<div id='grid' class='sub-grid' style='margin: 10px;'></div>",
            rowdetailsheight: 245,
            rowdetailshidden: true
          },
          columngroups: [
            { text: 'Clustering info', name: 'Clustering info', align: 'center' }
          ]
        };
        draw_patched_grid(".jqxgrid-currencies", currencies_datafields, currencies_columns, false,
            currencies_custom_source_data, currencies_custom_grid_options);
      {% endif %}

      {% if 'regulation' in available_locators %}
        // Top Regulation Usages table
        var regulations_datafields = [
          { name: 'regulation_name', type: 'string' },
          { name: 'regulation_type', type: 'string' },
          { name: 'count', type: 'int' },
          { name: 'regulation_data' }
        ];
        var regulations_menu_renderer = function(row_number) {
          var grid = $('.jqxgrid-regulations');
          var row = grid.jqxGrid('getrowdata', row_number);
          var menu_data = [
            { icon: 'fa fa-folder-open-o',
              onclick: "expand_row(event, '.jqxgrid-regulations', " + row_number + ")",
              text: 'Show Details' },
            { icon: 'fa fa-search',
              url:  '{% url "extract:regulation-usage-list" %}?regulation_search=' + encodeURIComponent(row.regulation_name),
              text: 'View Similar Regulation Usages' }
          ];
          show_menu(menu_data, grid, row.pk, 300);
        };
        var regulations_columns = [
          { text: 'Regulation Type', datafield: 'regulation_type', width: 'auto',
            align: 'center', cellsalign: 'center' },
          { text: 'Regulation Name', datafield: 'regulation_name', width: 'auto',
            align: 'center', cellsalign: 'center' },
          { text: 'Count', datafield: 'count', width: 150,
            align: 'center', cellsalign: 'center' },
          { text: 'Action', datafield: 'url', width: 60,
            align: 'center', exportable: false,
            columntype: 'button',
            sortable: false, filterable: false, menu: false,
            cellsrenderer: function(){return 'Menu'},
            buttonclick: regulations_menu_renderer }
        ];
        var regulations_custom_source_data = {
          url: '{% url "extract:top-regulation-usage-list" %}',
          data: { 'document_pk': {{ document.pk }} },
          badgeClass: 'regulations-badge'
        };
        draw_patched_grid(".jqxgrid-regulations", regulations_datafields, regulations_columns, false,
            regulations_custom_source_data, text_units_nested_grid_data('regulation_data'));
      {% endif %}

      {% if 'citation' in available_locators %}
        // Top Citation Usages table
        var citations_datafields = [
          { name: 'citation_str', type: 'string' },
          { name: 'count', type: 'int' },
          { name: 'citation_data' }
        ];
        var citations_menu_renderer = function(row_number) {
          var grid = $('.jqxgrid-citations');
          var row = grid.jqxGrid('getrowdata', row_number);
          var menu_data = [
            { icon: 'fa fa-folder-open-o',
              onclick: "expand_row(event, '.jqxgrid-citations', " + row_number + ")",
              text: 'Show Details' },
            { icon: 'fa fa-search',
              url:  '{% url "extract:citation-usage-list" %}?citation_search=' + encodeURIComponent(row.citation_str),
              text: 'View Similar Citation Usages' }
          ];
          show_menu(menu_data, grid, row.pk, 300);
        };
        var citations_columns = [
          { text: 'Citation', datafield: 'citation_str', width: 'auto',
            align: 'center', cellsalign: 'center' },
          { text: 'Count', datafield: 'count', width: 150,
            align: 'center', cellsalign: 'center' },
          { text: 'Action', datafield: 'url', width: 60,
            align: 'center', exportable: false,
            columntype: 'button',
            sortable: false, filterable: false, menu: false,
            cellsrenderer: function(){return 'Menu'},
            buttonclick: citations_menu_renderer }
        ];
        var citations_custom_source_data = {
          url: '{% url "extract:top-citation-usage-list" %}',
          data: { 'document_pk': {{ document.pk }} },
          badgeClass: 'citations-badge'
        };
        draw_patched_grid(".jqxgrid-citations", citations_datafields, citations_columns, false,
            citations_custom_source_data, text_units_nested_grid_data('citation_data'));
      {% endif %}

      {% if 'distance' in available_locators %}
        // Top Distance Usages table
        var distances_datafields = [
          { name: 'distance_type', type: 'string' },
          { name: 'amount', type: 'float' },
          { name: 'count', type: 'int' },
          { name: 'distance_data' }
        ];
        var distances_menu_renderer = function(row_number) {
          var grid = $('.jqxgrid-distances');
          var row = grid.jqxGrid('getrowdata', row_number);
          var menu_data = [
            { icon: 'fa fa-folder-open-o',
              onclick: "expand_row(event, '.jqxgrid-distances', " + row_number + ")",
              text: 'Show Details' },
            { icon: 'fa fa-search',
              url:  '{% url "extract:distance-usage-list" %}?distance_search=' + encodeURIComponent(row.distance_str),
              text: 'View Similar Distance Usages' }
          ];
          show_menu(menu_data, grid, row.pk, 300);
        };
        var distances_columns = [
          { text: 'Amount', datafield: 'amount', width: 'auto',
            align: 'center', cellsalign: 'center' },
          { text: 'Distance Type', datafield: 'distance_type', width: 'auto',
            align: 'center', cellsalign: 'center' },
          { text: 'Count', datafield: 'count', width: 150,
            align: 'center', cellsalign: 'center' },
          { text: 'Action', datafield: 'url', width: 60,
            align: 'center', exportable: false,
            columntype: 'button',
            sortable: false, filterable: false, menu: false,
            cellsrenderer: function(){return 'Menu'},
            buttonclick: distances_menu_renderer }
        ];
        var distances_custom_source_data = {
          url: '{% url "extract:top-distance-usage-list" %}',
          data: { 'document_pk': {{ document.pk }} },
          badgeClass: 'distances-badge'
        };
        draw_patched_grid(".jqxgrid-distances", distances_datafields, distances_columns, false,
            distances_custom_source_data, text_units_nested_grid_data('distance_data'));
      {% endif %}

      {% if 'amount' in available_locators %}
        // Top Amount Usages table
        var amounts_datafields = [
          { name: 'amount', type: 'float' },
          { name: 'count', type: 'int' },
          { name: 'amount_data' }
        ];
        var amounts_menu_renderer = function(row_number) {
          var grid = $('.jqxgrid-amounts');
          var row = grid.jqxGrid('getrowdata', row_number);
          var menu_data = [
            { icon: 'fa fa-folder-open-o',
              onclick: "expand_row(event, '.jqxgrid-amounts', " + row_number + ")",
              text: 'Show Details' },
            { icon: 'fa fa-search',
              url:  '{% url "extract:amount-usage-list" %}?amount_search=' + encodeURIComponent(row.amount),
              text: 'View Similar Amount Usages' }
          ];
          show_menu(menu_data, grid, row.pk, 300);
        };
        var amounts_columns = [
          { text: 'Amount', datafield: 'amount', width: 'auto',
            align: 'center', cellsalign: 'center' },
          { text: 'Count', datafield: 'count', width: 150,
            align: 'center', cellsalign: 'center' },
          { text: 'Action', datafield: 'url', width: 60,
            align: 'center', exportable: false,
            columntype: 'button',
            sortable: false, filterable: false, menu: false,
            cellsrenderer: function(){return 'Menu'},
            buttonclick: amounts_menu_renderer }
        ];
        var amounts_custom_source_data = {
          url: '{% url "extract:top-amount-usage-list" %}',
          data: { 'document_pk': {{ document.pk }} },
          badgeClass: 'amounts-badge'
        };
        draw_patched_grid(".jqxgrid-amounts", amounts_datafields, amounts_columns, false,
            amounts_custom_source_data, text_units_nested_grid_data('amount_data'));
      {% endif %}

      {% if 'percent' in available_locators %}
        // Top Percent Usages table
        var percents_datafields = [
          { name: 'unit_type', type: 'string' },
          { name: 'amount', type: 'float' },
          { name: 'count', type: 'int' },
          { name: 'percent_data' }
        ];
        var percents_menu_renderer = function(row_number) {
          var grid = $('.jqxgrid-percents');
          var row = grid.jqxGrid('getrowdata', row_number);
          var menu_data = [
            { icon: 'fa fa-folder-open-o',
              onclick: "expand_row(event, '.jqxgrid-percents', " + row_number + ")",
              text: 'Show Details' },
            { icon: 'fa fa-search',
              url:  '{% url "extract:percent-usage-list" %}?percent_type_search=' + encodeURIComponent(row.unit_type) +
              '&percent_amount_search=' + encodeURIComponent(row.amount),
              text: 'View Similar Percent Usages' }
          ];
          show_menu(menu_data, grid, row.pk, 300);
        };
        var percents_columns = [
          { text: 'Amount', datafield: 'amount', width: 'auto',
            align: 'center', cellsalign: 'center' },
          { text: 'Unit Type', datafield: 'unit_type', width: 'auto',
            align: 'center', cellsalign: 'center' },
          { text: 'Count', datafield: 'count', width: 150,
            align: 'center', cellsalign: 'center' },
          { text: 'Action', datafield: 'url', width: 60,
            align: 'center', exportable: false,
            columntype: 'button',
            sortable: false, filterable: false, menu: false,
            cellsrenderer: function(){return 'Menu'},
            buttonclick: percents_menu_renderer }
        ];
        var percents_custom_source_data = {
          url: '{% url "extract:top-percent-usage-list" %}',
          data: { 'document_pk': {{ document.pk }} },
          badgeClass: 'percents-badge'
        };
        draw_patched_grid(".jqxgrid-percents", percents_datafields, percents_columns, false,
            percents_custom_source_data, text_units_nested_grid_data('percent_data'));
      {% endif %}

      {% if 'ratio' in available_locators %}
        // Top Ratio Usages table
        var ratios_datafields = [
          { name: 'amount', type: 'float' },
          { name: 'amount2', type: 'float' },
          { name: 'count', type: 'int' },
          { name: 'ratio_data' }
        ];
        var ratios_menu_renderer = function(row_number) {
          var grid = $('.jqxgrid-ratios');
          var row = grid.jqxGrid('getrowdata', row_number);
          var menu_data = [
            { icon: 'fa fa-folder-open-o',
              onclick: "expand_row(event, '.jqxgrid-ratios', " + row_number + ")",
              text: 'Show Details' },
            { icon: 'fa fa-search',
              url:  '{% url "extract:ratio-usage-list" %}?ratio_amount_search=' + encodeURIComponent(row.amount) +
              '&ratio_amount2_search=' + encodeURIComponent(row.amount2),
              text: 'View Similar Ratio Usages' }
          ];
          show_menu(menu_data, grid, row.pk, 300);
        };
        var ratios_columns = [
          { text: 'Amount 1', datafield: 'amount', width: 'auto',
            align: 'center', cellsalign: 'center' },
          { text: 'Amount 2', datafield: 'amount2', width: 'auto',
            align: 'center', cellsalign: 'center' },
          { text: 'Count', datafield: 'count', width: 150,
            align: 'center', cellsalign: 'center' },
          { text: 'Action', datafield: 'url', width: 60,
            align: 'center', exportable: false,
            columntype: 'button',
            sortable: false, filterable: false, menu: false,
            cellsrenderer: function(){return 'Menu'},
            buttonclick: ratios_menu_renderer }
        ];
        var ratios_custom_source_data = {
          url: '{% url "extract:top-ratio-usage-list" %}',
          data: { 'document_pk': {{ document.pk }} },
          badgeClass: 'ratios-badge'
        };
        draw_patched_grid(".jqxgrid-ratios", ratios_datafields, ratios_columns, false,
            ratios_custom_source_data, text_units_nested_grid_data('ratio_data'));
      {% endif %}

      {% if 'copyright' in available_locators %}
        // Top Copyright Usages table
        var copyrights_datafields = [
          { name: 'copyright_str', type: 'string' },
          { name: 'count', type: 'int' },
          { name: 'copyright_data' }
        ];
        var copyrights_menu_renderer = function(row_number) {
          var grid = $('.jqxgrid-copyrights');
          var row = grid.jqxGrid('getrowdata', row_number);
          var menu_data = [
            { icon: 'fa fa-folder-open-o',
              onclick: "expand_row(event, '.jqxgrid-copyrights', " + row_number + ")",
              text: 'Show Details' },
            { icon: 'fa fa-search',
              url:  '{% url "extract:copyright-usage-list" %}?copyright_search=' + encodeURIComponent(row.copyright_str),
              text: 'View Similar Copyright Usages' }
          ];
          show_menu(menu_data, grid, row.pk, 300);
        };
        var copyrights_columns = [
          { text: 'Copyright', datafield: 'copyright_str', width: 'auto',
            align: 'center', cellsalign: 'center' },
          { text: 'Count', datafield: 'count', width: 150,
            align: 'center', cellsalign: 'center' },
          { text: 'Action', datafield: 'url', width: 60,
            align: 'center', exportable: false,
            columntype: 'button',
            sortable: false, filterable: false, menu: false,
            cellsrenderer: function(){return 'Menu'},
            buttonclick: copyrights_menu_renderer }
        ];
        var copyrights_custom_source_data = {
          url: '{% url "extract:top-copyright-usage-list" %}',
          data: { 'document_pk': {{ document.pk }} },
          badgeClass: 'copyrights-badge'
        };
        draw_patched_grid(".jqxgrid-copyrights", copyrights_datafields, copyrights_columns, false,
            copyrights_custom_source_data, text_units_nested_grid_data('copyright_data'));
      {% endif %}

      {% if 'trademark' in available_locators %}
        // Top Trademark Usages table
        var trademarks_datafields = [
          { name: 'trademark', type: 'string' },
          { name: 'count', type: 'int' },
          { name: 'trademark_data' }
        ];
        var trademarks_menu_renderer = function(row_number) {
          var grid = $('.jqxgrid-trademarks');
          var row = grid.jqxGrid('getrowdata', row_number);
          var menu_data = [
            { icon: 'fa fa-folder-open-o',
              onclick: "expand_row(event, '.jqxgrid-trademarks', " + row_number + ")",
              text: 'Show Details' },
            { icon: 'fa fa-search',
              url:  '{% url "extract:trademark-usage-list" %}?trademark_search=' + encodeURIComponent(row.trademark),
              text: 'View Similar Trademark Usages' }
          ];
          show_menu(menu_data, grid, row.pk, 300);
        };
        var trademarks_columns = [
          { text: 'Trademark', datafield: 'trademark', width: 'auto',
            align: 'center', cellsalign: 'center' },
          { text: 'Count', datafield: 'count', width: 150,
            align: 'center', cellsalign: 'center' },
          { text: 'Action', datafield: 'url', width: 60,
            align: 'center', exportable: false,
            columntype: 'button',
            sortable: false, filterable: false, menu: false,
            cellsrenderer: function(){return 'Menu'},
            buttonclick: trademarks_menu_renderer }
        ];
        var trademarks_custom_source_data = {
          url: '{% url "extract:top-trademark-usage-list" %}',
          data: { 'document_pk': {{ document.pk }} },
          badgeClass: 'trademarks-badge'
        };
        draw_patched_grid(".jqxgrid-trademarks", trademarks_datafields, trademarks_columns, false,
            trademarks_custom_source_data, text_units_nested_grid_data('trademark_data'));
      {% endif %}

      {% if 'url' in available_locators %}
        // Top Url Usages table
        var urls_datafields = [
          { name: 'source_url', type: 'string' },
          { name: 'goto_url', type: 'string' },
          { name: 'count', type: 'int' },
          { name: 'url_data' }
        ];
        var urls_menu_renderer = function(row_number) {
          var grid = $('.jqxgrid-urls');
          var row = grid.jqxGrid('getrowdata', row_number);
          var menu_data = [
            { icon: 'fa fa-folder-open-o',
              onclick: "expand_row(event, '.jqxgrid-urls', " + row_number + ")",
              text: 'Show Details' },
            { icon: 'fa fa-search',
              url:  '{% url "extract:url-usage-list" %}?url_search=' + encodeURIComponent(row.url),
              text: 'View Similar Url Usages' },
            { url: row.goto_url,
              icon: 'fa fa-external-link-square',
              text: 'Go to URL',
              target: '_blank' }
          ];
          show_menu(menu_data, grid, row.pk, 300);
        };
        var urls_columns = [
          { text: 'Url', datafield: 'source_url', width: 'auto',
            align: 'center', cellsalign: 'center' },
          { text: 'Count', datafield: 'count', width: 150,
            align: 'center', cellsalign: 'center' },
          { text: 'Action', datafield: 'url', width: 60,
            align: 'center', exportable: false,
            columntype: 'button',
            sortable: false, filterable: false, menu: false,
            cellsrenderer: function(){return 'Menu'},
            buttonclick: urls_menu_renderer }
        ];
        var urls_custom_source_data = {
          url: '{% url "extract:top-url-usage-list" %}',
          data: { 'document_pk': {{ document.pk }} },
          badgeClass: 'urls-badge'
        };
        draw_patched_grid(".jqxgrid-urls", urls_datafields, urls_columns, false,
            urls_custom_source_data, text_units_nested_grid_data('url_data'));
      {% endif %}

      // Task Queues table
      var task_queues_datafields = [
        { name: 'pk', type: 'int' },
        { name: 'description', type: 'string' },
        { name: 'complete_date', type: 'date' },
        { name: 'complete_user', type: 'string' },
        { name: 'open_url', type: 'string' },
        { name: 'remove_url', type: 'string' }
      ];
      var task_queues_menu_renderer = function(row, event) {
        var grid = $(event.currentTarget).parents('.jqxgrid');
        row = grid.jqxGrid('getrowdata', row);
        var menu_data = [
          { url: row.open_url,
            cls: 'mark-document-completed',
            icon: 'fa fa-gavel',
            text: row.complete_date ? 'Reopen Document' : 'Mark Document Completed' },
          { url: row.remove_url,
            cls: 'remove-from-task-queue',
            icon: 'fa fa-remove',
            text: 'Remove Document from this Task Queue' }
        ];
        show_menu(menu_data, grid, row.pk, 400);
      };
      var task_queues_columns = [
        { text: 'Description', datafield: 'description', width: 'auto',
          align: 'center', cellsalign: 'center' },
        { text: 'Date', datafield: 'complete_date', width: 150,
          filtertype: 'date', cellsformat: 'MM-dd-yyyy HH:mm',
          align: 'center', cellsalign: 'center', columngroup: 'Completed' },
        { text: 'User', datafield: 'complete_user', width: 150,
          align: 'center', cellsalign: 'center', columngroup: 'Completed' },
        { text: 'Action', datafield: 'edit_url', width: 60,
          align: 'center', exportable: false,
          columntype: 'button',
          sortable: false, filterable: false, menu: false,
          cellsrenderer: function(){return 'Menu'},
          buttonclick: task_queues_menu_renderer }
      ];
      var task_queues_custom_source_data = {
        url: '{% url "project:task-queue-list" %}',
        data: { 'document_pk': {{ document.pk }} },
        badgeClass: 'task-queues-badge'
      };
      var task_queues_custom_grid_options = {
        columngroups: [
          { text: 'Completed', name: 'Completed', align: 'center' }
        ]
      };
      draw_patched_grid(".jqxgrid-task-queues", task_queues_datafields, task_queues_columns, false,
          task_queues_custom_source_data, task_queues_custom_grid_options);

      // Clusters table
      var clusters_datafields = [
        { name: 'pk', type: 'int' },
        { name: 'cluster_id', type: 'int' },
        { name: 'name', type: 'string' },
        { name: 'self_name', type: 'string' },
        { name: 'description', type: 'string' },
        { name: 'type', type: 'string' },
        { name: 'count', type: 'int' },
        { name: 'created_date', type: 'date' },
        { name: 'documents' },
        { name: 'url', type: 'string' }
      ];
      var clusters_menu_renderer = function(row_number, event) {
        var grid = $(event.currentTarget).parents('.jqxgrid');
        var row = grid.jqxGrid('getrowdata', row_number);
        var menu_data = [
          { icon: 'fa fa-folder-open-o',
            onclick: "expand_row(event, '.jqxgrid', " + row_number + ")",
            text: 'Show Documents' }
        ];
        show_menu(menu_data, grid, row.pk);
      };
      var clusters_columns = [
        { text: 'Cluster Name', datafield: 'self_name', width: 'auto',
          align: 'center', cellsalign: 'center' },
        { text: 'Cluster#', datafield: 'cluster_id', width: 80,
          align: 'center', cellsalign: 'center' },
        { text: 'Name', datafield: 'name', width: 'auto',
          align: 'center', cellsalign: 'center', columngroup: 'Clustering info' },
        { text: 'Description', datafield: 'description', width: 'auto',
          align: 'center', cellsalign: 'center', columngroup: 'Clustering info' },
        { text: 'Cluster By', datafield: 'type', width: 80,
          align: 'center', cellsalign: 'center', columngroup: 'Clustering info' },
        { text: 'Documents', datafield: 'count', width: 80,
          align: 'center', cellsalign: 'center' },
        { text: 'Date', datafield: 'created_date', width: 120,
          filtertype: 'date', cellsformat: 'MM-dd-yyyy HH:mm',
          align: 'center', cellsalign: 'center' },
        { text: 'Action', datafield: 'edit_url', width: 60,
          align: 'center', exportable: false,
          columntype: 'button',
          sortable: false, filterable: false, menu: false,
          cellsrenderer: function(){return 'Menu'},
          buttonclick: clusters_menu_renderer }
      ];
      var clusters_custom_source_data = {
        url: '{% url "analyze:document-cluster-list" %}',
        data: { 'document_pk': {{ document.pk }} },
        badgeClass: 'clusters-badge'
      };
      // create nested grid.
      var clusters_initrowdetails = function(index, parentElement, gridElement, record) {
        var documents_grid = $($(parentElement).children()[1]);
        documents_grid.attr('id', 'grid' + record.boundindex);
        var details_source = {
          datafields: [
            { name: 'pk', type: 'int' },
            { name: 'name', type: 'string' },
            { name: 'description', type: 'string' },
            { name: 'document_type', type: 'string' },
            { name: 'url', type: 'string' }
          ],
          localdata: record.documents
        };
        var nestedGridAdapter = new $.jqx.dataAdapter(details_source);
        if (documents_grid != null) {
          var documents_menu_renderer = function(row) {
            row = documents_grid.jqxGrid('getrowdata', row);
            var menu_data = [
              { url: row.url,
                icon: 'fa fa-file-text-o',
                text: 'Document Details' }
            ];
            show_menu(menu_data, documents_grid, row.pk, 300);
          };
          documents_grid.jqxGrid({
            source: nestedGridAdapter,
            altrows: true,
            enabletooltips: true,
            sortable: true,
            filterable: true,
            width: '98%',
            height: 200,
            columns: [
              { text: 'Name', datafield: 'name', width: 'auto',
                cellsrenderer: defaultLinkFormatter,
                align: 'center', cellsalign: 'center' },
              { text: 'Description', datafield: 'description', width: 300,
                align: 'center', cellsalign: 'center' },
              { text: 'Type', datafield: 'document_type', width: 100,
                align: 'center', cellsalign: 'center' },
              { text: 'Action', datafield: 'edit_url', width: 60,
                align: 'center', exportable: false,
                columntype: 'button',
                sortable: false, filterable: false, menu: false,
                cellsrenderer: function(){return 'Menu'},
                buttonclick: documents_menu_renderer }
            ]
          });
        }
      };
      var clusters_custom_grid_options = {
        rowsheight: 60,
        pageable: false,
        rowdetails: true,
        initrowdetails: clusters_initrowdetails,
        rowdetailstemplate: {
          rowdetails: "<div class='sub-grid-title'>Documents</div><div id='grid' class='sub-grid'></div>",
          rowdetailsheight: 245,
          rowdetailshidden: true
        },
        columngroups: [
          { text: 'Clustering info', name: 'Clustering info', align: 'center' }
        ]
      };
      draw_patched_grid(".jqxgrid-clusters", clusters_datafields, clusters_columns, false,
          clusters_custom_source_data, clusters_custom_grid_options);

      // Document Similarity table
      var similarity_datafields = [
        { name: 'document_b__pk', type: 'int' },
        { name: 'document_b__name', type: 'string' },
        { name: 'document_b__document_type__title', type: 'string' },
        { name: 'document_b__project__name', type: 'string' },
        { name: 'document_b__url', type: 'string' },
        { name: 'similarity', type: 'float' }
      ];
      var document_b_name_renderer = function(index, columnfield, value, defaulthtml, columnproperties, row){
        return linkFormatter(defaulthtml, row.document_b__url, value);
      };
      var similarity_columns = [
        { text: 'ID', datafield: 'document_b__pk', width: 50,
          align: 'center', cellsalign: 'center' },
        { text: 'Name', datafield: 'document_b__name', width: 'auto', minwidth: 300,
          align: 'center', cellsalign: 'left',
          cellsrenderer: document_b_name_renderer },
        { text: 'Document Type', datafield: 'document_b__document_type__title', width: 'auto',
          enabletooltips: true,
          align: 'center', cellsalign: 'center' },
        { text: 'Project', datafield: 'document_b__project__name', width: 'auto',
          align: 'center', cellsalign: 'center' },
        { text: 'Similarity', datafield: 'similarity', width: 100,
          align: 'center', cellsalign: 'center', cellsformat: 'p2' }
      ];
      var similarity_custom_source_data = {
        url: '{% url "analyze:document-similarity-list" %}',
        data: { 'document_pk': {{ document.pk }} },
        badgeClass: 'similarity-badge'
      };
      draw_patched_grid(".jqxgrid-similarity", similarity_datafields, similarity_columns, true, similarity_custom_source_data);

      if (window.location.hash.indexOf('tab') != -1 ){
        var tab_map = window.location.hash.split('-');
        var tab_no = tab_map.length == 2 ? tab_map[1] : tab_map[2];
        $('a[href="#tab-' + tab_no + '"]').tab('show');
      }
      $('#tabs1 a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
        // e.target // newly activated tab
        // e.relatedTarget // previous active tab
        var other_tab = $(e.target).hasClass('other');
        var other_content = other_tab ? $(e.target).html() : '<span>Other items</span>';
        $('#tab1-other span').html(other_content)
      })
    });
  </script>
  {% include "document/_note_js.html" %}
{% endblock %}
