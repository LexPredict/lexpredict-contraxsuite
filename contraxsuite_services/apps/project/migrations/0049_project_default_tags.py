# Generated by Django 2.2.13 on 2020-12-22 13:03
from typing import Set

from django.db import migrations, connection


def set_term_and_company_default_tags(_apps, _schema_editor):
    with connection.cursor() as cursor:
        cursor.execute('SELECT id FROM project_project;')
        project_ids = {r[0] for r in cursor.fetchall()}

        # if the project doesn't have a term tag - give him "default"
        set_project_default_tags(
            cursor, project_ids,
            'project_project_term_tags',
            'extract_termtag',
            'termtag_id')

        # if the project doesn't have a company tag - give him "default"
        set_project_default_tags(
            cursor, project_ids,
            'project_project_companytype_tags',
            'extract_companytypetag',
            'companytypetag_id')


def set_project_default_tags(cursor,
                             project_ids: Set[int],
                             joint_table: str,
                             tag_table: str,
                             tag_fk_column: str):
    cursor.execute(f'SELECT project_id FROM {joint_table};')
    set_projects = {r[0] for r in cursor.fetchall()}
    unset_projects = project_ids - set_projects
    cursor.execute(f'SELECT name, id FROM {tag_table};')
    tag_by_name = {name: id for name, id in cursor.fetchall()}
    default_tag_id = tag_by_name.get('default')
    if default_tag_id is None:
        cursor.execute(f"INSERT INTO {tag_table} (name) VALUES ('default') RETURNING id;")
        default_tag_id = cursor.fetchone()[0]
    value_clause = ','.join([f'({p}, {default_tag_id})' for p in unset_projects])
    if value_clause:
        cursor.execute(f'''INSERT INTO {joint_table}
                               (project_id, {tag_fk_column}) VALUES {value_clause}''')


class Migration(migrations.Migration):

    dependencies = [
        ('extract', '0063_companytype_companytypetag'),
        ('project', '0048_project_companytype_tags'),
    ]

    operations = [
        migrations.RunPython(set_term_and_company_default_tags,
                             reverse_code=migrations.RunPython.noop)
    ]
