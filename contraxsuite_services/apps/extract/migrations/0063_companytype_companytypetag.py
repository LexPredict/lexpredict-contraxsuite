# Generated by Django 2.2.13 on 2020-12-22 11:58
from typing import Dict

from django.db import migrations, models, connection


def migrate_company_types(_, __):
    from lexnlp.extract.en.entities.nltk_maxent import default_company_detector
    from lexnlp.config.en.company_types import CompanyDescriptor
    comp_types: Dict[str, CompanyDescriptor] = default_company_detector.company_types
    with connection.cursor() as cursor:
        cursor.execute('''INSERT INTO extract_companytypetag("name") VALUES ('default') RETURNING id;''')
        default_tag_id = cursor.fetchone()[0]

        for alias in comp_types:
            abr = comp_types[alias].abbreviation
            label = comp_types[alias].label
            cursor.execute(f'''INSERT INTO extract_companytype ("alias", "abbreviation", "label")
                               VALUES (%s, %s, %s) RETURNING id;''', (alias, abr, label,))
            comp_type_id = cursor.fetchone()[0]
            cursor.execute(f'''INSERT INTO extract_companytype_tags ("companytype_id", "companytypetag_id")
                               VALUES (%s, %s);''', (comp_type_id, default_tag_id,))


class Migration(migrations.Migration):

    dependencies = [
        ('extract', '0062_auto_20201207_1241'),
    ]

    operations = [
        migrations.CreateModel(
            name='CompanyTypeTag',
            fields=[
                ('id', models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(db_index=True, default='default', max_length=100, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='CompanyType',
            fields=[
                ('id', models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('alias', models.CharField(db_index=True, max_length=512, unique=True)),
                ('abbreviation', models.CharField(db_index=True, max_length=128, null=True)),
                ('label', models.CharField(db_index=True, max_length=512, null=True)),
                ('tags', models.ManyToManyField(blank=True, db_index=True, to='extract.CompanyTypeTag')),
            ],
            options={
                'ordering': ('alias', 'abbreviation'),
            },
        ),
        migrations.RunPython(migrate_company_types, reverse_code=migrations.RunPython.noop)
    ]
