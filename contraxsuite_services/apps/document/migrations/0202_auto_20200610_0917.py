# Generated by Django 2.2.13 on 2020-06-10 09:17

import apps.document.models
from django.db import migrations, models
import django.db.models.deletion


def update(apps, schema_editor):
    DocumentFieldCategory = apps.get_model('document', 'DocumentFieldCategory')
    for category in DocumentFieldCategory.objects.all():
        doc_type_ids = set(category.documentfield_set.values_list('document_type', flat=True))
        for n, document_type_id in enumerate(doc_type_ids):
            # import ipdb;ipdb.set_trace()
            if n == 0:
                category.document_type_id = document_type_id
                category.save()
            else:
                new_category = DocumentFieldCategory.objects.create(
                    name=category.name,
                    document_type_id=document_type_id
                )
                category.documentfield_set.filter(document_type_id=document_type_id).update(category=new_category)


class Migration(migrations.Migration):

    dependencies = [
        ('document', '0201_auto_20200513_1844'),
    ]

    operations = [
        migrations.AddField(
            model_name='documentfieldcategory',
            name='document_type',
            field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.CASCADE, related_name='categories', to='document.DocumentType'),
        ),
        migrations.RunPython(
            update,
            migrations.RunPython.noop
        ),
    ]
